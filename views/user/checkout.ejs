<!DOCTYPE html>
<html lang="en">
<!-- Basic -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Site Metas -->
    <title>ThewayShop - Ecommerce Bootstrap 4 HTML Template</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Site Icons -->
    <link rel="shortcut icon" href="im/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrapd.min.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="css/styled.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsived.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/customd.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
    <!-- Start Main Top -->
   
    <!-- End Main Top -->

    <!-- Start Main Top -->
    <header class="main-header">
        <!-- Start Navigation -->
        
        <!-- End Navigation -->
    </header>
    <!-- End Main Top -->

    <!-- Start Top Search -->
  
    <!-- Start All Title Box -->
    <div class="all-title-box">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h2>Checkout</h2>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Shop</a></li>
                        <li class="breadcrumb-item active">Checkout</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- End All Title Box -->
 
    <!-- Start Cart  -->
    <div class="cart-box-main">
        
        <div class="container">
            <div class="row new-account-login">
                <div class="col-sm-6 col-lg-6 mb-3">
                    <div class="title-left">
                        <h3>Create Address</h3>
                    </div>
                   <form action="/store-address" method="post">
                   
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="Full Name">Full Name *</label>
                                <input type="text" class="form-control" id="firstName" name="fullName" placeholder="" value="" required>
                                <div class="invalid-feedback"> Valid first name is required. </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="Mobile Number">Contact Number*</label>
                                <input type="text" class="form-control" id="" placeholder="" name="mobileNumber" value="" required>
                                <div class="invalid-feedback"> Valid last name is required. </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="House No">House Name/No/a *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="username" placeholder="" name="houseNo" required>
                                <div class="invalid-feedback" style="width: 100%;"> Your username is required. </div>
                            </div>
                        </div>

                      
                        <div class="row">
                            <div class="col-md-5 mb-3">
                                <label for="Street">Street *</label>
                                <input type="text" class="form-control" id="city"  name="street" required>
                           
                                <div class="invalid-feedback"> Please select a valid country. </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state">State *</label>
                                <input type="text" class="form-control" id="state" name="state" required>
                            
                                <div class="invalid-feedback"> Please provide a valid state. </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="zip">Zip *</label>
                                <input type="text" class="form-control" id="zip" placeholder="" name="zip" required>
                                <div class="invalid-feedback"> Zip code required. </div>
                            </div>
                        </div>
                       
                        <button type="submit" class="btn hvr-hover">Submit</button>
                    </form>
                    <div class="row">
                      <div class="col-sm-6 col-lg-6 mb-3">
                          <div class="checkout-address" style="padding: 10px;">
                              <div class="title-left">
                                  <h3>Payment</h3>
                              </div>
                              <form class="needs-validation" novalidate id="checkoutForm">
                                  <div class="d-block my-3">
                                      <div class="custom-control custom-radio">
                                          <input id="rzp-button1" name="paymentMethod" type="radio" class="custom-control-input" value="card" required>
                                          <label class="custom-control-label" for="rzp-button1">Card Payment</label>
                                      </div>
                                     
                                     
                                      <div class="custom-control custom-radio">
                                          <input id="cod" name="paymentMethod" value="cod" type="radio" class="custom-control-input" required>
                                          <label class="custom-control-label"   for="cod">Cash on Delivery</label>
                                      </div>
                                  </div>
                                 
                                      <div class="col-md-6 mb-3">
                                          <div class="payment-icon">
                                              <ul>
                                                  <li><img class="img-fluid" src="img/payment-icon/1.png" alt=""></li>
                                                  <li><img class="img-fluid" src="img/payment-icon/2.png" alt=""></li>
                                                  <li><img class="img-fluid" src="img/payment-icon/3.png" alt=""></li>
                                                  <li><img class="img-fluid" src="img/payment-icon/7.png" alt=""></li>
                                              </ul>
                                          </div>
                                      </div>
                                  </div>
                                  <hr class="mb-1"> </form>
                          </div>
                      </div>
                  <!-- Inside the checkout form -->
<div class="shoping__discount">
  <h5>Discount Codes</h5>
  <form id="couponForm">
    <input type="text" id="couponCode" placeholder="Enter your coupon code">
    <button type="submit" class="site-btn">APPLY COUPON</button>
  </form>
</div>

                </div>
                
             
                <div class="col-sm-6 col-lg-6 mb-3">
                    <div class="title-left">
                        <h3>Shipping & Billing address</h3>
                    </div>
                        <style>
                            .address-list {
                              margin-top: 20px;
                            }
                          
                            .address-row {
                              overflow: hidden;
                              margin-bottom: 20px;
                            }
                          
                            .address {
                              float: left;
                              width: 50%;
                              padding: 10px;
                            
                          
                              margin-bottom: 10px;
                              box-sizing: border-box;
                            }
                          
                            .address label {
                              display: block;
                            }
                          
                            @media (max-width: 767px) {
                              .address {
                                width: 100%;
                              }
                            }
                            .hidden-text {
                              display: none;
                        }
                          </style>
                        
                        <% if (addresses.length > 0) { %>
                            <div class="address-list">
                              <% addresses.forEach((address, addressIndex) => { %>
                                <% if (addressIndex % 2 === 0) { %>
                                  <div class="address-row">
                                    <div class="address">
                                      <input type="radio" id="address<%= addressIndex %>" name="selectedAddress" value="<%= address._id%>" />
                                      <label>
                                        <div class="field">
                                          <span class="value"><%= address.name %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.phone %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.housenumber %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.street %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.state %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.postcode %></span>
                                        </div>
                                      </label>
                                    </div>
                                <% } else { %>
                                    <div class="address">
                                      <input type="radio" id="address<%= addressIndex %>" name="selectedAddress" value="<%= address._id%>" />
                                      <label>
                                        <div class="field">
                                          <span class="value"><%= address.name %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.phone %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.housenumber %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.street %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.state %></span>
                                        </div>
                                        <div class="field">
                                          <span class="value"><%= address.postcode %></span>
                                        </div>
                                        
                                      </label>
                                    </div>
                                  </div>
                                <% } %>
                              <% }) %>
                            </div>
                          <% } else { %>
                            <!-- Display create address form here -->
                            <div class="create-address-form">
                              <!-- Your create address form HTML code goes here -->
                            </div>
                          <% } %>
                          
                          
                      
                      
                
            </div>
            
           
                <div class="col-sm-6 col-lg-6 mb-3">
                    <div class="row">
                       
                        <div class="col-md-12 col-lg-12">
                            <div class="odr-box">
                                <div class="title-left">
                                    <h3>Shopping cart</h3>
                                </div>
                                <div class="rounded p-2 bg-light">
                                    <% cartItems.forEach((item) => { %>
                                    <div class="media mb-2 border-bottom">
                                        <div class="media-body"> <span class="hidden-text"><%= item.product._id %></span>  <h6> <%= item.product.productname %> </h6>
                                            <div class="small text-muted">Price:<%= item.offer_price %> <span class="mx-2">|</span>Qty:<%= item.quantity %> <span class="mx-2">|</span> Subtotal:Rs.<%= item.offer_price * item.quantity %></div>
                                        </div>
                                    </div>
                                    <% }) %>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-lg-12">
                            <div class="order-box">
                                <div class="title-left">
                                    <h3>Your order</h3>
                                </div>
                                <div class="d-flex">
                                    <div class="font-weight-bold">Product</div>
                                    <div class="ml-auto font-weight-bold">Total</div>
                                </div>
                                <hr class="my-1">
                                <div class="d-flex">
                                    <h4>Sub Total</h4>
                                    <div class="ml-auto font-weight-bold"><span id="originalAmount">Calculating...</span></span></div>
                                   
                                </div>
                                <div class="d-flex">
                                    <h4>Discount</h4>
                                    <div class="ml-auto font-weight-bold"><span id="discountAmount">discountAmount</span> </div>
                                </div>
                                <hr class="my-1">
                             
                              
                              
                                <div class="d-flex">
                                    <h4>Shipping Cost</h4>
                                    <div class="ml-auto font-weight-bold"> Free </div>
                                </div>
                                <hr>
                                <div class="d-flex ">
                                    <h5>Grand Total</h5>
                                    <div class="ml-auto font-weight-bold"><span id="totalAmount">Calculating...</span></span></div>
                                </div>
                                <hr> </div>
                        </div>
                        <div class="col-12 d-flex shopping-box"> <button id="placeOrderBtn" type="button" class="btn hvr-hover">Place Order</button>


                    </div>
                </div>
            </div>
        </form>
        </div>
    </form>
    </div>
    </div>
   
   
    
  
    <!-- End Cart -->

    <!-- Start Instagram Feed  -->
    
    <!-- End copyright  -->

    <a href="#" id="back-to-top" title="Back to top" style="display: none;">&uarr;</a>

    <!-- ALL JS FILES -->
    <script src="js/jquery-3.2.1.min.js"></script>
    
    <script src="js/bootstrap.min.js"></script>
    <!-- ALL PLUGINS -->
    <script src="js/jquery.superslides.min.js"></script>
    <script src="js/bootstrap-select.js"></script>
   
  
    
    <script src="js/owl.carousel.min.js"></script>
   
    <script src="js/form-validator.min.js"></script>
   <script>
    // JavaScript code to calculate and update the total amount dynamically
    document.addEventListener('DOMContentLoaded', function() {
        var totalAmount = 0; // Declare totalAmount variable
        
        updateTotalAmount();
        updateOriginalPrice();
        
        function updateTotalAmount() {
            totalAmount = 0; // Reset totalAmount before calculating
            <% cartItems.forEach((item) => { %>
                totalAmount += <%= item.offer_price %> * <%= item.quantity %>;
            <% }) %>
            
            document.getElementById('totalAmount').textContent = 'Rs ' + totalAmount.toFixed(2);
        }
        console.log("for checking",totalAmount)
        
        function updateOriginalPrice() {
            var originalAmount = 0;
            <% cartItems.forEach((item) => { %>
                originalAmount += <%= item.product.price %> * <%= item.quantity %>;
            <% }) %>
            
            document.getElementById('originalAmount').textContent = 'Rs ' + originalAmount.toFixed(2);
            
            var discountAmount = originalAmount - totalAmount;
            document.getElementById('discountAmount').textContent = 'Rs ' + discountAmount.toFixed(2);
        }
    });



    // Inside your existing script
document.getElementById('couponForm').addEventListener('submit', function (event) {
  event.preventDefault();

  const couponCode = document.getElementById('couponCode').value;
  const grandTotal = parseFloat(document.getElementById('totalAmount').textContent.slice(3)); // Remove "Rs " from the total amount

  // Send the coupon code and grand total to the server for validation and discount calculation
  fetch('/coupon/apply', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ couponCode, grandTotal })
  })
    .then(response => response.json())
    .then(data => {
      // Update the total amount on the client side with the calculated discount (if applicable)
      if (data.grandTotal !== grandTotal) {
        document.getElementById('totalAmount').textContent = 'Rs ' + data.grandTotal.toFixed(2);
        alert('Coupon applied successfully!');
      } else {
        alert('The coupon has already used or expired.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('The coupon has expired.');
    });
});

    </script>
    



<script src="https://checkout.razorpay.com/v1/checkout.js"></script>




    <script>




function placeOrder() {
  const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
  if (!selectedAddress) {
    alert('Please select an address.');
    return;
  }

  const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
  if (!selectedPayment) {
    alert('Please select a payment method.');
    return;
  }

  const paymentMethod = selectedPayment.value;

  const orderData = {
    addressId: selectedAddress.value,
    paymentMethod: paymentMethod,
    totalAmount: document.getElementById('totalAmount').textContent,
    subTotal: document.getElementById('originalAmount').textContent,
    discount: document.getElementById('discountAmount').textContent,
    products: []
  };

  const productItems = document.querySelectorAll('.media.mb-2.border-bottom');
  productItems.forEach(item => {
    const hiddenText = item.querySelector('.hidden-text');
    if (hiddenText) {
      const productId = hiddenText.textContent;
      const priceText = item.querySelector('.small.text-muted').textContent;
      const quantity = parseInt(priceText.match(/Qty:(\d+)/)[1]);
      const price = parseFloat(priceText.match(/Subtotal:Rs\.(\d+(?:\.\d+)?)/)[1]);

      const product = {
        _id: productId,
        quantity: quantity,
        price: price
      };
      orderData.products.push(product);
    }
  });

  fetch('/submit-order', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(orderData)
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (paymentMethod === "cod") {
          window.location.href = '/success';
        } else {
          const razorpayOrderId = data.razorpayOrderId;
          const options = {
            key: 'rzp_test_oLMzBcAQa08Hks', // Replace with your Razorpay API key
            amount: parseFloat(orderData.totalAmount) * 100, // Amount in paise or the smallest currency unit
            currency: 'INR',
            order_id: razorpayOrderId,
            name: 'Your Store Name',
            description: 'Order Payment',
            handler: function (response) {
              if (response.razorpay_payment_id) {
                window.location.href = '/success'; // Redirect to the success page if payment is successful
              } else {
                alert('Payment failed or canceled. Please try again.');
              }
            },
            prefill: {
              name: 'John Doe', // Replace with the customer's name
              email: 'john@example.com', // Replace with the customer's email
              contact: '9876543210' // Replace with the customer's contact number
            }
          };
          const razorpayInstance = new Razorpay(options);
          razorpayInstance.open();
        }
      } else {
        alert('Failed to place order. Please try again.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to place order. Please try again.');
    });
}

document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);

</script>

  
    
   

</body>

</html>